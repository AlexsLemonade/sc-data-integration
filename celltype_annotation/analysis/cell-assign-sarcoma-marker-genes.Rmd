---
title: "CellAssign: Rhabdomyosarcoma using marker genes"
output: 
  html_notebook:
    toc: true
    toc_float: true
params:
  library_id: "SCPCL000488"
  sample_id: "SCPCS000262"
---

Since it's fairly obvious that `CellAssign`, although better at assigning `NA` than `SingleR`, is still going to be highly dependent on the marker genes that are in the reference, I wanted to see how well `CellAssign` performs when we provide marker genes that we know are associated with the cell types found in the dataset.

Here I use `scran::FindMarkers()` to get the top markers for each of the cell types and then use that as the reference gene by cell matrix for `CellAssign`.
I expect that the output of `CellAssign` should be fairly consistent with the annotations we have using this method.

## Set Up

```{r}
library(SingleCellExperiment)
library(ggplot2)
```

```{r}
# Set up paths 

# build path to annotated sce file 
processed_sce_file <- glue::glue("{params$library_id}_processed_celltype.rds")
processed_sce_path <- file.path("..", "data", params$sample_id, processed_sce_file)

# output matrix files 
rms_matrix_file <- file.path("..", "references", "rms_broad_markers_mtx.csv")

# anndata input
anndata_dir <- file.path("..", "data", "anndata")
anndata_file <- glue::glue("{params$library_id}_anndata.hdf5")
anndata_file <- file.path(anndata_dir, anndata_file)
fs::dir_create(anndata_dir)

# cellassign predictions
rms_prediction_file <- file.path(
  anndata_dir, 
  glue::glue("{params$library_id}_rms_broad_markers.tsv")
)

```

```{r}
# read in all annotated sce 
processed_sce <- readr::read_rds(local_processed_sce_path)
```

```{r}
# source helper functions
function_file <- file.path("..", "utils", "cellassign-helper-functions.R")
source(function_file)
```

## Get marker genes

```{r}
# extract coldata for easy plotting
coldata_df <- colData(processed_sce) |>
  as.data.frame() |> 
  dplyr::select(barcode, celltype) |>
  # classify cells as tumor or normal
  dplyr::mutate(cell_category = dplyr::if_else(stringr::str_detect(celltype, "Tumor"), "Tumor", celltype),
                # remove sub states of myoblast/mesoderm/myocyte
                broad_celltype = stringr::str_remove(celltype, "-A|-B|-C|-D"))
```


```{r}
# find markers for all cell types 
processed_sce_markers <- scran::findMarkers(processed_sce,
                                            groups = coldata_df$broad_celltype,
                                            pval.type = "all")
```


```{r}
# get top 20 markers for each cell type 
top_markers_df <- as.list(processed_sce_markers) |>
  purrr::imap(
    \(markers, id) 
    markers |> 
      as.data.frame() |>
      dplyr::arrange(desc(summary.logFC)) |>
      dplyr::mutate(celltype = id) |>
      tibble::rownames_to_column("ensembl_id") |> 
      dplyr::select(celltype, ensembl_id) |>
      head(n = 10)
  ) |>
  dplyr::bind_rows()

# create a binary matrix of genes by cell type markers 
markers_binary_mtx <- top_markers_df |>
  dplyr::select(celltype, ensembl_id) |> 
  tidyr::pivot_wider(ensembl_id,
                     names_from = celltype,
                     values_from = celltype,
                     values_fn = length,
                     values_fill = 0) |> 
  tibble::column_to_rownames("ensembl_id") |>
  dplyr::mutate(other = 0)

# replace length with 1
markers_binary_mtx[markers_binary_mtx > 1] <- 1

# add ensembl id as first column
markers_binary_mtx <- markers_binary_mtx |>
  tibble::rownames_to_column("ensembl_id") |>
  dplyr::relocate(ensembl_id)
```

```{r}
# look at myoblast markers, are they what we expect? 
myoblast_markers <- top_markers_df |>
  dplyr::filter(celltype == "Tumor_Myoblast")

# do some mapping to get the gene symbols
myoblast_markers <- AnnotationDbi::mapIds(
    # organism annotation package
    org.Hs.eg.db::org.Hs.eg.db,
    # the provided gene identifiers
    keys = myoblast_markers$ensembl_id,
    # the type of provided gene identifiers
    keytype = "ENSEMBL",
    # the type of gene identifiers to map to
    column = "SYMBOL"
  ) |>
    tibble::enframe(name = 'ensembl_id',
                    value = tolower("SYMBOL")) |> 
    dplyr::left_join(myoblast_markers, by = "ensembl_id")

myoblast_markers
```
I kind of would expect some of the myoblast markers to be included here like `MYOG`, `MYF5`, `MYOD1`, etc. 

## Run CellAssign
```{r}
# export mtx 
readr::write_csv(markers_binary_mtx, rms_matrix_file)
```

```{r,  eval = FALSE}
# run cell assign with muscle ref
cellassign_call <- glue::glue("
python ../scripts/cell-assign.py \
  --input_anndata '{anndata_file}' \
  --output_predictions '{rms_prediction_file}' \
  --reference '{rms_matrix_file}'
")

system(cellassign_call)
```

## Evaluate CellAssign

```{r}
# read in prediction scores 
rms_predictions <- readr::read_tsv(rms_prediction_file)
```

```{r}
# heatmap of prediction scores 
rms_predictions |>
  dplyr::select(-barcode) |> 
  as.matrix() |> 
  pheatmap::pheatmap(show_rownames = FALSE)
```

This actuallylooks pretty good! 
We see most of the cells are assigned to `Tumor_Myoblast` which is what is expected.

```{r}
# add rms marker gene assignments to sce object
rms_assignments <- get_celltype_assignments(rms_predictions)
coldata_df$rms_assignments <- rms_assignments$celltype
```

```{r}
# compare to broad celltype annotations
compare_refs_heatmap(original_assignment = coldata_df$broad_celltype,
                     cell_assign = coldata_df$rms_assignments)
```

Although there is not perfect agreement, we do see that for many of the cell types the majority of cells are classified as the expected cell type.

## Session Info

```{r}
sessionInfo()
```
