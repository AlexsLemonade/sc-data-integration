---
title: "CellAssign: Rhabdomyosarcoma using public references"
output: 
  html_notebook:
    toc: true
    toc_float: true
params:
  library_id: "SCPCL000488"
  sample_id: "SCPCS000262"
    
---

This notebook evaluates using `CellAssign` for cell type assignment. 
Here we are looking specifically at a rhabdomyosarcoma sample that we have known cell type annotations for and comparing those known annotations to using `CellAssign` with two different marker lists. 

- [CellMarker2.0](http://117.50.127.228/CellMarker/)
- [PanglaoDB](https://panglaodb.se/index.html)

The marker gene lists for both were downloaded and are found in the `references` directory.
After reading in the marker gene lists, I filtered them to only contain relevant tissue types related to sarcoma (e.g., mucscle, connective tissue).
The filtered list of cell type markers is turned into a binary gene by cell type matrix with an additional "other" column where no marker genes are found. 
This is used as input to run `CellAssign` using `scripts/cell-assign.py`. 
The output of that script is a prediction matrix where each row is a cell barcode and each column is a cell type found in the reference matrix. 
The corresponding cell type with the top score for each barcode is then assigned to that cell. 

## Set Up

```{r}
library(SingleCellExperiment)
library(ggplot2)
```

```{r}
# Set up paths 

# build path to annotated sce file 
processed_data_dir <-file.path("..", "data") 
processed_sce_file <- glue::glue("{params$library_id}_processed_celltype.rds")
local_processed_sce_path <- file.path(processed_data_dir, params$sample_id, processed_sce_file)

# anndata output
anndata_dir <- file.path("..", "data", "anndata")
anndata_file <- glue::glue("{params$library_id}_anndata.hdf5")
anndata_file <- file.path(anndata_dir, anndata_file)
fs::dir_create(anndata_dir)

# reference files for cell marker
ref_dir <- file.path("..", "references")
excel_celltype_file <- file.path(ref_dir, "Cell_marker_Human.xlsx")
panglao_file <- file.path(ref_dir, "PanglaoDB_markers_27_Mar_2020.tsv")

# output matrix files 
cell_marker_mtx_file <- file.path(ref_dir, "cell_marker_muscle_mtx.csv")
panglao_matrix_file <- file.path(ref_dir, "panglao_connective_tissue_mtx.csv")

# cellassign predictions
cellmarker_prediction_file <- file.path(
  anndata_dir, 
  glue::glue("{params$library_id}_muscle.tsv")
)
panglao_prediction_file <- file.path(
  anndata_dir, 
  glue::glue("{params$library_id}_panglao_connective_tissue.tsv")
)

```


```{r}
# read in all annotated sce 
processed_sce <- readr::read_rds(local_processed_sce_path)
```

```{r}
# write out anndata 
scpcaTools::sce_to_anndata(processed_sce, anndata_file = anndata_file)
```

```{r}
# source helper functions
function_file <- file.path("..", "utils", "cellassign-helper-functions.R")
source(function_file)
```

## CellMarker2.0

```{r}
# read in excel file
celltype_markers_df <- openxlsx::read.xlsx(excel_celltype_file)
```


```{r}
# look at different tissue types available 
celltype_markers_df |>
  dplyr::count(tissue_class)
```

```{r}
celltype_markers_df |> 
  dplyr::count(cancer_type, cellontology_id, cell_name) |>
  dplyr::mutate(sarcoma_filter = stringr::str_detect(cancer_type, "sarcoma")) |>
  dplyr::filter(sarcoma_filter)
```


```{r}
# grab the muscle tissue type
muscle_markers_df <- celltype_markers_df |> 
  dplyr::filter(tissue_class == "Muscle") |>
  tidyr::drop_na(cellontology_id, Symbol)

# print total number of marker genes for each cellontology id
muscle_markers_df |>
  dplyr::count(cell_name, cancer_type, cellontology_id)
```


```{r}
# create a binary matrix of genes by cell type markers 
cellmarker_mtx <- muscle_markers_df |>
  dplyr::select(cellontology_id, Symbol) |> 
  tidyr::pivot_wider(Symbol,
                     names_from = cellontology_id,
                     values_from = cellontology_id,
                     values_fn = length,
                     values_fill = 0) |> 
  tibble::column_to_rownames("Symbol") |>
  dplyr::mutate(other = 0)

# replace length with 1
cellmarker_mtx[cellmarker_mtx > 1] <- 1
```



```{r}
# convert rownames to ensembl ids
rowdata_df <- rowData(processed_sce) |>
  as.data.frame() |>
  tibble::rownames_to_column("ensembl_id") |>
  dplyr::select(ensembl_id, gene_symbol)

# merge reference with rowdata and replace gene symbols with ensembl
cellmarker_mtx <- cellmarker_mtx |>
  tibble::rownames_to_column("gene_symbol") |>
  dplyr::left_join(rowdata_df) |>
  # drop any rows where there is no ensembl id
  tidyr::drop_na(ensembl_id) |>
  dplyr::select(-gene_symbol) |>
  dplyr::relocate(ensembl_id)
```

```{r}
# export mtx 
readr::write_csv(cellmarker_mtx, cell_marker_mtx_file)
```

```{r,  eval = FALSE}
# run cell assign with muscle ref
cellassign_call <- glue::glue("
python ../scripts/cell-assign.py \
  --input_anndata '{anndata_file}' \
  --output_predictions '{cellmarker_prediction_file}' \
  --reference '{cell_marker_mtx_file}'
")

system(cellassign_call)
```


```{r}
# read in prediction scores 
cellmarker_predictions <- readr::read_tsv(cellmarker_prediction_file)
```

```{r}
# grab cell label names corresponding to cell ontology ids
cl_ont <- ontoProc::getCellOnto()

# replace column names(ontology ids) with cell label
cellmarker_predictions <- cellmarker_predictions |>
  dplyr::rename_with(
    \(cl_id) 
    cl_ont$name[stringr::str_replace(cl_id, "_", ":")],
    !any_of(c("barcode", "other"))
)
```



```{r}
# get assignments for each cell from prediction matrix 
cellmarker_assignments <- get_celltype_assignments(cellmarker_predictions)

# print table of assignments
cellmarker_assignments |>
  dplyr::count(celltype) |>
  dplyr::arrange(desc(n))
  
```

```{r}
# heatmap of prediction scores 
cellmarker_predictions |>
  dplyr::select(-barcode) |> 
  as.matrix() |> 
  pheatmap::pheatmap(show_rownames = FALSE)
```

Here most of the cells appear to be assigned to macrophages... 
According to the known cell type annotations most of the cell types here are tumor cells and of those tumor cells they are mostly myoblasts. 

```{r}
# print out markers that were associated with macrophages during assignment
muscle_markers_df |>
  dplyr::filter(cell_name == "Macrophage")
```

What's strange is that CD163 and CD68 aren't present in our SCE object, only PTPRC and it is not highly expressed.

```{r}
processed_sce$cellmarker_assignments <- cellmarker_assignments$celltype

# PTPRC is the only gene that's found in our dataset and the other two are not? 
scater::plotReducedDim(processed_sce,
                       dimred = "UMAP",
                       colour_by = "ENSG00000081237",
                       other_fields = "cellmarker_assignments",
                       point_size = 0.5,
                       point_alpha = 0.5) +
  facet_wrap(~ cellmarker_assignments)
```
Let's also look at the marker genes for the myoblast population that was used in our reference file. 
Looking at the original annotations for this sample, most of the cells should be myoblasts. 

```{r}
# print out markers that were associated with myoblast during assignment
# cancer myoblasts
muscle_markers_df |>
  dplyr::filter(cancer_type == "Rhabdomyosarcoma", 
                cell_name == "Myoblast")

# normal myoblast markers
muscle_markers_df |>
  dplyr::filter(cancer_type == "Normal", 
                cell_name == "Myoblast") |>
  dplyr::select(cancer_type, cell_name, cellontology_id, Symbol, Genename) |> 
  unique()
```
How do some of these marker genes look when looking at our data? 
Are they expressed in what we would expect to be the myoblasts? 
Looking back on the original paper, `MYF5`, `MSC`, and `PAX7` are pulled out as markers for the myoblast population. 
`MSC` is not in this list and not expressed in our dataset. 
The other two are both in the marker gene list and in our dataset, but how highly are they expressed in the population that gets labeled as `Tumor_myoblast`? 

```{r}
# marker genes for myoblasts from paper
# MYF5 ENSG00000111049
# MSC ENSG00000178860 (not in marker genes listed from cellmarker or our dataset)
# PAX7 ENSG00000009709

scater::plotReducedDim(processed_sce,
                       dimred = "UMAP",
                       colour_by = "ENSG00000111049", #MYF5
                       other_fields = "celltype",
                       point_size = 0.5,
                       point_alpha = 0.5) +
  facet_wrap(~ celltype)

scater::plotReducedDim(processed_sce,
                       dimred = "UMAP",
                       colour_by = "ENSG00000009709", #PAX7
                       other_fields = "celltype",
                       point_size = 0.5,
                       point_alpha = 0.5) +
  facet_wrap(~ celltype)
```

## PanglaoDB

```{r}
# read in panglao db 
panglao_df <- readr::read_tsv(panglao_file)
```


```{r}
# overview of available organs to choose from 
panglao_df |>
  dplyr::count(organ)
```

```{r}
# grab all muscle related organs
panglao_connective_tissue <- panglao_df |> 
  dplyr::filter(organ %in% c("Connective tissue", "Smooth muscle", "Skeletal muscle"))

panglao_connective_tissue |>
  dplyr::count(`cell type`, `organ`)
```


```{r}
# create a binary matrix of genes by cell type markers 
panglao_binary_mtx <- panglao_connective_tissue |>
  dplyr::select('cell type', 'official gene symbol') |> 
  tidyr::pivot_wider('official gene symbol',
                     names_from = 'cell type',
                     values_from = 'cell type',
                     values_fn = length,
                     values_fill = 0) |> 
  tibble::column_to_rownames("official gene symbol") |>
  dplyr::mutate(other = 0)

# replace length with 1
panglao_binary_mtx[panglao_binary_mtx > 1] <- 1
```

```{r}
# merge reference with rowdata and replace gene symbols with ensembl
panglao_binary_mtx <- panglao_binary_mtx |>
  tibble::rownames_to_column("gene_symbol") |>
  dplyr::left_join(rowdata_df) |>
  # drop any rows where there is no ensembl id
  tidyr::drop_na(ensembl_id) |>
  dplyr::select(-gene_symbol) |>
  dplyr::relocate(ensembl_id)
```

```{r}
# export mtx 
readr::write_csv(panglao_binary_mtx, panglao_matrix_file)
```

```{r,  eval = FALSE}
# run cell assign with muscle ref
cellassign_call <- glue::glue("
python ../scripts/cell-assign.py \
  --input_anndata '{anndata_file}' \
  --output_predictions '{panglao_prediction_file}' \
  --reference '{panglao_matrix_file}'
")

system(cellassign_call)
```


```{r}
# read in prediction scores 
panglao_predictions <- readr::read_tsv(panglao_prediction_file)
```

```{r}
panglao_assignments <- get_celltype_assignments(panglao_predictions)

# print table of assignments
panglao_assignments |>
  dplyr::count(celltype) |>
  dplyr::arrange(desc(n))
```

```{r}
# heatmap of prediction scores 
panglao_predictions |>
  dplyr::select(-barcode) |> 
  as.matrix() |> 
  pheatmap::pheatmap(show_rownames = FALSE)
```
Here the majority of cells are getting classified as `other` with a small group of fibroblasts and myocytes. 

Look at the marker genes that were used for the Myoblast celltype. 

```{r}
panglao_connective_tissue |>
  dplyr::filter(`cell type` == "Myoblasts")
```

```{r}
# add celltypes to processed sce 
processed_sce$panglao_assignments <- panglao_assignments$celltype

scater::plotReducedDim(processed_sce,
                       dimred = "UMAP",
                       colour_by = "ENSG00000111049", #MYF5
                       other_fields = "panglao_assignments",
                       point_size = 0.5,
                       point_alpha = 0.5) +
  facet_wrap(~ panglao_assignments)

scater::plotReducedDim(processed_sce,
                       dimred = "UMAP",
                       colour_by = "ENSG00000009709", #PAX7
                       other_fields = "panglao_assignments",
                       point_size = 0.5,
                       point_alpha = 0.5) +
  facet_wrap(~ panglao_assignments)
```


## Reference comparison 

To understand how CellAssign is assigning each of the cell types vs. the original assignments, let's directly compare references below.


```{r}
# extract coldata for easy plotting
coldata_df <- colData(processed_sce) |>
  as.data.frame() |> 
  dplyr::select(barcode, celltype, cellmarker_assignments, panglao_assignments) |>
  # classify cells as tumor or normal
  dplyr::mutate(cell_category = dplyr::if_else(stringr::str_detect(celltype, "Tumor"), "Tumor", celltype),
                # remove sub states of myoblast/mesoderm/myocyte
                broad_celltype = stringr::str_remove(celltype, "-A|-B|-C|-D"))
```


```{r}
# tumor/normal vs. cellmarker 
compare_refs_heatmap(original_assignment = coldata_df$cell_category,
                     cell_assign = coldata_df$cellmarker_assignments)
```


```{r}
# tumor/normal vs. panglao
compare_refs_heatmap(original_assignment = coldata_df$cell_category,
                     cell_assign = coldata_df$panglao_assignments)
```

```{r}
# all celltypes vs. cell marker 
compare_refs_heatmap(original_assignment = coldata_df$broad_celltype,
                     cell_assign = coldata_df$cellmarker_assignments)
```

```{r}
# all cell types vs. panglao
compare_refs_heatmap(original_assignment = coldata_df$broad_celltype,
                     cell_assign = coldata_df$panglao_assignments)
```

As expected, `CellAssign` seems to be struggling with the tumor cells and depending on the reference has been assigning them to `other` or `macrophage`. 
There are a few places where the normal cells match up in their assignment, but they are also not perfectly in agreement. 

## Session Info

```{r}
sessionInfo()
```

