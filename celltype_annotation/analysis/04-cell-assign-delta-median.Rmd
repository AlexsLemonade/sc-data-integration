---
title: "CellAssign: Evaluate delta median metric"
output: 
  html_notebook:
    toc: true
    toc_float: true
    code_folding: "hide"
---

This notebook examines ways to evaluate confidence in the cell type assignments that are obtained from using `CellAssign`. 
In particular, we would like to see if we can use a similar delta median metric that we are using for `SingleR`. 
The delta median metric is calculated by taking the top score or prediction from `CellAssign` and subtracting the median prediction for each cell in the dataset. 

This notebook will look at `CellAssign` results from previous analysis.
In particular, we will read in the results from running `CellAssign` with a blood cancer dataset (see `marker-gene-celltype-exploration.Rmd`) and a sarcoma dataset (see `02-cell-assign-sarcoma-marker-genes.Rmd` and `03-cell-assign-combined-markers.Rmd`).

For the blood cancer dataset, we used a follicular lymphoma reference with and without B-cells (referred to as `all_cells` or `no_bcells`).
For the sarcoma dataset, we used either the combination of cell types from immune and muscle in PanglaoDB (`combined_muscle`) and a reference obtained from calculating the marker gene expression for each submitter assigned cell type (`rms_markers`). 

A few things to keep in mind: 

- Here the output of `CellAssign` is a prediction, instead of a score. 
This prediction value can be equated to a probability and is on a 0-1 scale.
From the [`CellAssign` paper](https://doi.org/10.1038/s41592-019-0529-1): 
> Using this information, CellAssign employs a hierarchical statistical framework to compute the probability that each cell belongs to the modeled cell types, while jointly estimating all model parameters using an expectation-maximization inference algorithm.

- `CellAssign` looks for high expression of indicated marker genes.
It cannot assign classes based on low or medium expression of a marker gene. 
This assumes that any marker genes used in the reference should be highly expressed in the cell types that are assigned. 


## Set Up

```{r}
library(SingleCellExperiment)
library(ggplot2)

# source helper functions
function_file <- file.path("..", "utils", "cellassign-helper-functions.R")
source(function_file)
```

```{r}
# Set up paths 
cellassign_results_dir <- file.path("cellassign_results")

# blood predictions 
all_cells_preds_file <- file.path(cellassign_results_dir, "SCPCL000295_all_cells_predictions.tsv")
no_bcells_preds_file <- file.path(cellassign_results_dir, "SCPCL000295_no_bcells_predictions.tsv")
blood_preds_files <- list(
  all_cells = all_cells_preds_file,
  no_bcells = no_bcells_preds_file
)

# sarcoma predictions 
rms_markers_preds_file <- file.path(cellassign_results_dir, "SCPCL000488_rms_broad_markers.tsv")
comb_muscle_preds_file <- file.path(cellassign_results_dir, "SCPCL000488_panglao_combined.tsv")
rms_preds_files <- list(
  combined_muscle = comb_muscle_preds_file,
  rms_markers = rms_markers_preds_file
)
```

```{r}
# read in prediction files  
blood_predictions <- purrr::map(blood_preds_files, readr::read_tsv)
rms_predictions <- purrr::map(rms_preds_files, readr::read_tsv)
```

```{r}
# grab annotated sce objects for use later 
data_dir <- file.path("..", "data")
blood_annotated_rds <- file.path(data_dir, "SCPCS000221", "SCPCL000295_annotated.rds")
rms_annotated_rds <- file.path(data_dir, "SCPCS000262", "SCPCL000488_annotated.rds")

# read in annotated sce
blood_sce <- readr::read_rds(blood_annotated_rds)
rms_sce <- readr::read_rds(rms_annotated_rds)
```


```{r}
# read in reference files 
# we will use these later to look at marker genes specific to each reference
ref_dir <- file.path("..", "references")
blood_all_cells_ref <- readr::read_csv(file.path(ref_dir, "FL_celltype_ensembl.csv"))
blood_no_bcells_ref <- readr::read_csv(file.path(ref_dir, "FL_celltype_ensembl-noBcells.csv"))
combined_muscle_ref <- readr::read_csv(file.path(ref_dir, "panglao_combined_mtx.csv"))
rms_ref <- readr::read_csv(file.path(ref_dir, "rms_broad_markers_mtx.csv"))
```

## Median Delta

Below we will calculate the difference between the top prediction and the median prediction for every cell. 
The prediction scores that come from `CellAssign` are equivalent to probabilities. 
The higher the median delta score, the larger the difference between the probability of the cell type assigned being correct and the probability of other cell types being correct. 

We will compare the distribution of delta median scores across references used and cell types. 
If a reference is more appropriate, we would expect a higher distribution of delta median scores. 

```{r}
# calculate the blood median delta probability 
blood_median_delta <- purrr::map(blood_predictions, get_median_delta_cellassign) |>
  dplyr::bind_rows(.id = "reference")

# get the actual cell type assignments 
# based on cell type with the highest probability 
blood_celltype <- purrr::map(blood_predictions, get_celltype_assignments) |>
  dplyr::bind_rows(.id = "reference")

# combine into a single data frame for plotting
blood_results_df <- dplyr::left_join(blood_celltype, blood_median_delta)
```

```{r}
# compare references to each other 
plot_median_delta(blood_results_df, color_group = "reference")
```

```{r}
# separate by cell type
plot_median_delta(blood_results_df)
```

```{r}
# median delta for rms data
rms_median_delta <- purrr::map(rms_predictions, get_median_delta_cellassign) |>
  dplyr::bind_rows(.id = "reference")

# actual cell type calls
rms_celltype <- purrr::map(rms_predictions, get_celltype_assignments) |>
  dplyr::bind_rows(.id = "reference")

# combine into a single data frame
rms_results_df <- dplyr::left_join(rms_celltype, rms_median_delta)
```

```{r}
# compare across references used 
plot_median_delta(rms_results_df, color_group = "reference")
```

```{r}
# compare across cell types
# here cell types are different based on the reference used so we will split these into two plots 
split(rms_results_df, rms_results_df$reference) |>
  purrr::map(plot_median_delta)
```

When comparing the distribution of delta median scores for each of the references, we do see a difference between the two references for each organ type. 
For blood, it looks like there's a higher concentration of delta median scores closer to 1 with the all cells reference vs. the reference without B-cells. 
For sarcoma, the reference produced from using marker genes specific to the dataset rather than PanglaoDB is more appropriate, which is what we would expect. 

However, if we break it down by cell type, we generally see that the delta median scores are high across each cell type. 
This means that when a cell is called a specific type, the probability of the cell type being the best assignment is high. 

## Probability scores 

Because `CellAssign` directly outputs probabilities, rather than an arbitrary score, let's just look directly at the probabilities. 

Here we will plot the entire distribution of probabilities for each cell type. 
For each cell type, we label which cells were assigned to the cell type indicatd on the x-axis with the `top_celltype` label. 
We are looking for all cells with high probability of being assigned to a given cell type to be assigned to that cell type. 
Additionally, the probability of them being assigned to a different cell type should be low. 

```{r}
# create combined data frame with all prediction scores 
combined_predictions_results <- join_cellassign_results(blood_celltype, 
                                                        blood_predictions) |> 
  dplyr::bind_rows() |> 
  # only show probabilities associated with the called celltype 
  dplyr::filter(predicted_celltype == celltype)

# plot comparing the probabilities associatd with assigned cell types in blood
ggplot(combined_predictions_results, aes(x = reference, y = probability)) +
        ggforce::geom_sina(size = 0.5, alpha = 0.2) +
        theme_bw()
```


```{r}
# separate by cell type
plot_probability(blood_celltype,
                 blood_predictions)
```
```{r}
combined_predictions_results <- join_cellassign_results(rms_celltype, 
                                                        rms_predictions) |> 
  dplyr::bind_rows() |> 
  # only show probabilities associated with the called celltype 
  dplyr::filter(predicted_celltype == celltype)
  
# plot comparing the probabilities associatd with assigned cell types in rms
ggplot(combined_predictions_results, aes(x = reference, y = probability)) +
        ggforce::geom_sina(size = 0.5, alpha = 0.2) +
        theme_bw()
```


```{r}
# separate by cell type
plot_probability(rms_celltype,
                 rms_predictions)
```

Overall it appears that the distribution of probabilities is slightly higher in sarcoma when using the `rms_markers` reference over the combined muscle reference. 
This fits with the expectation that the cell types found in `rms_markers` are more appropriate than the cell types in the muscle reference. 

Additionally, when looking at the distribution of probabilities by cell type, we see that overall cells with a high probability in a specific cell type have a low probability in other cell types. 
This is consistent with the median delta score showing high differences between the top probability and the median probability for each cell. 

## Marker gene expression 

Because `CellAssign` strictly looks for increased expression of defined marker genes to assign cell types, here I specifically look at the expression of the marker genes in each reference across the assigned cell types. 
I would expect that the marker genes for a cell type would be highly expressed in cells that are assigned to that cell type and have lower expression in other cell types. 

However, it is not a linear relationship between marker genes and cell type assignment, so not having high expression in all genes may be expected. 
Looking at these plots may highlight cell types that `CellAssign` is less confident in. 
If there are cases with increased gene expression of a set of marker genes in two cell types, then you may expect that defining those two cell types would be more difficult. 

```{r fig.height = 10, warning=FALSE,message=FALSE}
# look at rms marker gene expression
plot_marker_gene_exp(ref_mtx = rms_ref,
                     combined_results = rms_results_df,
                     ref_name = "rms_markers",
                     annotated_sce = rms_sce) +
  labs(title = "RMS Marker Genes Reference")
```
Here we see that expression of marker genes for non-tumor cells (e.g., Fibroblasts and Vascular Endothelium) is pretty defined to only the assigned cell types. 
In the tumor cells (Tumor_Myoblast and Tumor_Myocyte specifically), there is high expression of both marker gene sets.
I would associated this with some of the misassignment that is happening between those two cell classes. 
(see `02-cell-assign-sarcoma-marker-genes.Rmd`)

```{r fig.height = 20,warning=FALSE,message=FALSE}
# look at combined muscle reference 
plot_marker_gene_exp(ref_mtx = combined_muscle_ref,
                     combined_results = rms_results_df,
                     ref_name = "combined_muscle",
                     annotated_sce = rms_sce) +
  labs(title = "RMS Combined muscle Reference")
```

Looking at this, it looks like Myocytes have high expression of myocyte specific marker genes. 
However, they also have high expression of many other marker genes.
Perhaps that is why `CellAssign` is having trouble assigning myocytes (and other cell types) using this reference.

## Conclusions

- Looking at the delta median prediction/probability score appears to be high across all cell types, regardless of quality of cell type assignment, at least in the libraries and references examined here. 
- The distribution of the probability appears to be helpful in distinguishing good vs. bad references. 
However, when looking across assigned cell types, probabilities still generally are high for the assigned cell type. 
- Looking at the marker gene expression non-tumor cells appear to have more distinct expression of marker genes than tumor cells.
The reference that has fewer cell types is easier to interpret, but perhaps looking at marker gene expression would be helpful for users evaluating cell type assignment? 

## Session Info

```{r}
sessionInfo()
```

